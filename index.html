<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Courier Helper</title>

<script src="https://unpkg.com/html5-qrcode"></script>
<script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>

<style>
body { margin:0; font-family:sans-serif; background:#f2f2f2; }
.page { display:none; padding:10px; }
.page.active { display:block; }

.camera-box {
  height:60vh;
  background:black;
  position:relative;
}

#barcodeCam, #addressVideo {
  width:100%;
  height:100%;
}

video {
  width:100%;
  height:100%;
  object-fit:cover;
}

.controls {
  background:#fff;
  padding:10px;
}

button, input, textarea {
  width:100%;
  padding:12px;
  margin-top:8px;
  font-size:16px;
}
</style>
</head>

<body>

<!-- BARCODE PAGE -->
<div id="pageBarcode" class="page active">
  <h3>Scan Barcode</h3>

  <div class="camera-box">
    <div id="barcodeCam"></div>
  </div>

  <div class="controls">
    <input id="manualBarcode" placeholder="Enter barcode manually">
    <button onclick="barcodeNext()">Next</button>
  </div>
</div>

<!-- ADDRESS PAGE -->
<div id="pageAddress" class="page">
  <h3>Capture Address</h3>

  <div class="camera-box">
    <video id="addressVideo" autoplay playsinline></video>
  </div>

  <div class="controls">
    <button onclick="captureAddress()">ðŸ“¸ Capture Address</button>
    <button onclick="goBack()">â¬… Back</button>
  </div>
</div>

<!-- REVIEW PAGE -->
<div id="pageReview" class="page">
  <h3>Review</h3>

  <input id="name" placeholder="Name">
  <input id="phone" placeholder="Phone">
  <textarea id="address" rows="4" placeholder="Address"></textarea>
  <input id="city" placeholder="City">
  <input id="pincode" placeholder="Pincode">

  <button onclick="saveEntry()">Approve & Save</button>
  <button onclick="rescanAddress()">Rescan Address</button>
</div>

<!-- EXPORT PAGE -->
<div id="pageExport" class="page">
  <h3>Saved Data</h3>
  <pre id="output"></pre>

  <button onclick="startNew()">Scan New</button>
  <button onclick="exportAll()">Export All</button>
</div>

<script>
let scanner;
let barcode = "";
let stream;
let entries = [];

function showPage(id) {
  document.querySelectorAll(".page").forEach(p => p.classList.remove("active"));
  document.getElementById(id).classList.add("active");
}

/* ---------- BARCODE ---------- */
function startBarcode() {
  if (scanner) scanner.stop().catch(()=>{});
  scanner = new Html5Qrcode("barcodeCam");
  scanner.start(
    { facingMode:"environment" },
    { fps:10, qrbox:250 },
    txt => {
      barcode = txt;
      manualBarcode.value = txt;
      scanner.stop();
    }
  );
}
startBarcode();

function barcodeNext() {
  barcode = manualBarcode.value.trim();
  if (!barcode) return alert("Barcode required");
  showPage("pageAddress");
  startAddressCamera();
}

/* ---------- ADDRESS CAMERA ---------- */
async function startAddressCamera() {
  stream = await navigator.mediaDevices.getUserMedia({
    video:{ facingMode:"environment" }
  });
  addressVideo.srcObject = stream;
}

function captureAddress() {
  const v = addressVideo;
  const c = document.createElement("canvas");
  c.width = v.videoWidth;
  c.height = v.videoHeight;
  c.getContext("2d").drawImage(v, 0, 0);
  stream.getTracks().forEach(t => t.stop());
  runOCR(c.toDataURL());
}

/* ---------- OCR ---------- */
async function runOCR(img) {
  alert("Reading addressâ€¦");
  const r = await Tesseract.recognize(img, "eng");
  parseText(r.data.text);
  showPage("pageReview");
}

function parseText(t) {
  address.value = t.trim();
  phone.value = (t.match(/\b\d{10}\b/)||[""])[0];
  pincode.value = (t.match(/\b\d{6}\b/)||[""])[0];
  city.value = (t.match(/Bangalore|Chennai|Mumbai|Delhi|Hyderabad/i)||[""])[0];
  name.value = t.split("\n")[0];
}

/* ---------- SAVE ---------- */
function saveEntry() {
  entries.push({
    barcode, name:name.value, phone:phone.value,
    address:address.value, city:city.value, pincode:pincode.value
  });
  output.textContent = JSON.stringify(entries, null, 2);
  showPage("pageExport");
}

/* ---------- UTILS ---------- */
function rescanAddress() {
  showPage("pageAddress");
  startAddressCamera();
}

function goBack() {
  showPage("pageBarcode");
  startBarcode();
}

function startNew() {
  showPage("pageBarcode");
  startBarcode();
}

function exportAll() {
  const b = new Blob([JSON.stringify(entries)], {type:"application/json"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(b);
  a.download = "courier-data.json";
  a.click();
}
</script>

</body>
</html>
