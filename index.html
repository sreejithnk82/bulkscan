<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Courier Booking Helper</title>

<script src="https://unpkg.com/html5-qrcode"></script>
<script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>

<style>
body {
  margin: 0;
  height: 100vh;
  display: flex;
  flex-direction: column;
  font-family: system-ui, sans-serif;
  overflow: hidden;
}

#camera {
  flex: 1;
  background: black;
  position: relative;
}

#controls {
  padding: 12px;
  background: #fff;
  border-top: 1px solid #ccc;
}

input, textarea, button {
  width: 100%;
  font-size: 16px;
  padding: 10px;
  margin-top: 8px;
}

button {
  background: #007bff;
  color: white;
  border: none;
  border-radius: 4px;
}

.secondary {
  background: #6c757d;
}

.hidden {
  display: none;
}

#cropBox {
  position: absolute;
  border: 2px dashed yellow;
  width: 80%;
  height: 40%;
  top: 30%;
  left: 10%;
  pointer-events: none;
}
</style>
</head>

<body>

<div id="camera"></div>

<div id="controls">

  <!-- STEP 1 -->
  <div id="stepBarcode">
    <strong>Scan Barcode</strong>
    <div id="reader"></div>
    <input id="barcodeInput" placeholder="Enter / verify barcode">
    <button onclick="goToAddress()">Next</button>
  </div>

  <!-- STEP 2 -->
  <div id="stepAddress" class="hidden">
    <strong>Capture Address</strong>
    <button onclick="captureAddress()">Capture Address</button>
    <button class="secondary" onclick="backToBarcode()">Back</button>
  </div>

  <!-- STEP 3 -->
  <div id="stepReview" class="hidden">
    <strong>Review Address</strong>

    <input id="name" placeholder="Name">
    <input id="phone" placeholder="Phone">
    <textarea id="address" rows="4" placeholder="Address"></textarea>
    <input id="city" placeholder="City">
    <input id="pin" placeholder="PIN">

    <button onclick="saveEntry()">Approve & Save</button>
    <button class="secondary" onclick="rescanAddress()">Rescan Address</button>
  </div>

  <!-- STEP 4 -->
  <div id="stepActions" class="hidden">
    <button onclick="startNew()">Scan New</button>
    <button class="secondary" onclick="exportAll()">Export All</button>
  </div>

</div>

<canvas id="canvas" class="hidden"></canvas>

<script>
/* ------------------ GLOBAL ------------------ */
let qr;
let barcode = "";
let addressVideo, addressStream;
let db;

/* ------------------ DB ------------------ */
const req = indexedDB.open("courierDB", 1);
req.onupgradeneeded = e => {
  db = e.target.result;
  db.createObjectStore("scans", { autoIncrement: true });
};
req.onsuccess = e => db = e.target.result;

/* ------------------ BARCODE ------------------ */
function startBarcodeScanner() {
  camera.innerHTML = '<div id="reader"></div>';
  qr = new Html5Qrcode("reader");

  qr.start(
    { facingMode: "environment" },
    { fps: 10, qrbox: { width: 250, height: 120 } },
    text => barcodeInput.value = text
  );
}

startBarcodeScanner();

async function goToAddress() {
  barcode = barcodeInput.value.trim();
  if (!barcode) return alert("Barcode required");

  await qr.stop();
  await qr.clear();

  stepBarcode.classList.add("hidden");
  stepAddress.classList.remove("hidden");

  startAddressCamera();
}

/* ------------------ ADDRESS CAMERA ------------------ */
async function startAddressCamera() {
  addressVideo = document.createElement("video");
  addressVideo.setAttribute("playsinline", true);
  addressVideo.autoplay = true;

  addressStream = await navigator.mediaDevices.getUserMedia({
    video: { facingMode: "environment" }
  });

  addressVideo.srcObject = addressStream;
  camera.innerHTML = "";
  camera.appendChild(addressVideo);

  const crop = document.createElement("div");
  crop.id = "cropBox";
  camera.appendChild(crop);
}

function captureAddress() {
  const canvas = document.getElementById("canvas");
  const ctx = canvas.getContext("2d");

  if (!addressVideo.videoWidth) {
    alert("Camera not ready. Try again.");
    return;
  }

  canvas.width = addressVideo.videoWidth;
  canvas.height = addressVideo.videoHeight;

  ctx.filter = "grayscale(1) contrast(1.4)";
  ctx.drawImage(addressVideo, 0, 0);

  processOCR(canvas);
}

/* ------------------ OCR ------------------ */
async function processOCR(canvas) {
  const w = canvas.width, h = canvas.height;

  const crop = document.createElement("canvas");
  crop.width = w * 0.8 * 1.5;
  crop.height = h * 0.4 * 1.5;

  crop.getContext("2d").drawImage(
    canvas,
    w * 0.1, h * 0.3, w * 0.8, h * 0.4,
    0, 0, crop.width, crop.height
  );

  const result = await Tesseract.recognize(crop, "eng", {
    preserve_interword_spaces: 1
  });

  parseAddress(result.data.text);
}

/* ------------------ PARSER ------------------ */
function parseAddress(text) {
  stepAddress.classList.add("hidden");
  stepReview.classList.remove("hidden");

  address.value = text.trim();

  phone.value = (text.match(/(?:\+91[-\s]?)?[6-9]\d{9}/) || [""])[0];
  pin.value = (text.match(/\b\d{6}\b/) || [""])[0];

  const lines = text.split("\n").map(l => l.trim()).filter(Boolean);
  name.value = lines.find(l => /^[A-Za-z .]{3,}$/.test(l)) || "";
  city.value = lines[lines.length - 2] || "";
}

/* ------------------ SAVE ------------------ */
function saveEntry() {
  const tx = db.transaction("scans", "readwrite");
  tx.objectStore("scans").add({
    barcode,
    name: name.value,
    phone: phone.value,
    address: address.value,
    city: city.value,
    pin: pin.value,
    time: Date.now()
  });

  stepReview.classList.add("hidden");
  stepActions.classList.remove("hidden");
}

/* ------------------ NAV ------------------ */
function rescanAddress() {
  stepReview.classList.add("hidden");
  stepAddress.classList.remove("hidden");
}

function backToBarcode() {
  addressStream.getTracks().forEach(t => t.stop());
  stepAddress.classList.add("hidden");
  stepBarcode.classList.remove("hidden");
  startBarcodeScanner();
}

function startNew() {
  addressStream.getTracks().forEach(t => t.stop());
  stepActions.classList.add("hidden");
  stepBarcode.classList.remove("hidden");
  barcodeInput.value = "";
  startBarcodeScanner();
}

/* ------------------ EXPORT ------------------ */
function exportAll() {
  const tx = db.transaction("scans", "readonly");
  const store = tx.objectStore("scans");
  const data = [];

  store.openCursor().onsuccess = e => {
    const cur = e.target.result;
    if (cur) {
      data.push(cur.value);
      cur.continue();
    } else {
      const blob = new Blob([JSON.stringify(data, null, 2)], { type: "application/json" });
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = "courier_data.json";
      a.click();

      if (confirm("Clear stored data?")) {
        db.transaction("scans", "readwrite").objectStore("scans").clear();
      }
    }
  };
}
</script>

</body>
</html>
