<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Courier Booking Helper</title>

<script src="https://unpkg.com/html5-qrcode"></script>
<script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>

<style>
html, body {
  margin: 0;
  height: 100%;
  overflow: hidden;
  font-family: system-ui, sans-serif;
}

/* ðŸ”’ GRID = NO OVERLAP EVER */
#app {
  height: 100dvh; /* dynamic viewport */
  display: grid;
  grid-template-rows: 60% 40%;
}

/* CAMERA AREA */
#camera {
  background: black;
  position: relative;
  overflow: hidden;
}

/* CONTROLS */
#controls {
  background: white;
  overflow-y: auto;
  padding: 12px;
  border-top: 1px solid #ccc;
}

input, textarea, button {
  width: 100%;
  font-size: 16px;
  padding: 10px;
  margin-top: 8px;
}

button {
  background: #007bff;
  color: white;
  border: none;
  border-radius: 4px;
}

.secondary {
  background: #6c757d;
}

.hidden {
  display: none;
}

/* CROP GUIDE */
#cropBox {
  position: absolute;
  border: 2px dashed yellow;
  width: 80%;
  height: 40%;
  top: 30%;
  left: 10%;
  pointer-events: none;
}
</style>
</head>

<body>
<div id="app">

  <div id="camera"></div>

  <div id="controls">

    <!-- STEP 1 -->
    <div id="stepBarcode">
      <strong>Scan Barcode</strong>
      <div id="reader"></div>
      <input id="barcodeInput" placeholder="Enter or verify barcode">
      <button onclick="goToAddress()">Next</button>
    </div>

    <!-- STEP 2 -->
    <div id="stepAddress" class="hidden">
      <strong>Capture Address</strong>
      <button onclick="captureAddress()">Capture Address</button>
      <button class="secondary" onclick="backToBarcode()">Back</button>
    </div>

    <!-- STEP 3 -->
    <div id="stepReview" class="hidden">
      <strong>Review</strong>
      <input id="name" placeholder="Name">
      <input id="phone" placeholder="Phone">
      <textarea id="address" rows="3"></textarea>
      <input id="city" placeholder="City">
      <input id="pin" placeholder="PIN">
      <button onclick="saveEntry()">Save</button>
    </div>

    <!-- STEP 4 -->
    <div id="stepActions" class="hidden">
      <button onclick="startNew()">Scan New</button>
      <button class="secondary" onclick="exportAll()">Export</button>
    </div>

  </div>
</div>

<canvas id="canvas" class="hidden"></canvas>

<script>
let qr, video, stream, barcode = "", db;

/* DB */
indexedDB.open("courierDB", 1).onupgradeneeded = e =>
  e.target.result.createObjectStore("scans", { autoIncrement: true });

indexedDB.open("courierDB", 1).onsuccess = e => db = e.target.result;

/* BARCODE */
function startBarcodeScanner() {
  camera.innerHTML = '<div id="reader"></div>';
  qr = new Html5Qrcode("reader");
  qr.start({ facingMode: "environment" }, { fps: 10, qrbox: 200 },
    txt => barcodeInput.value = txt);
}
startBarcodeScanner();

async function goToAddress() {
  barcode = barcodeInput.value.trim();
  if (!barcode) return alert("Barcode required");

  await qr.stop(); await qr.clear();
  stepBarcode.classList.add("hidden");
  stepAddress.classList.remove("hidden");
  startAddressCamera();
}

/* ADDRESS CAMERA */
async function startAddressCamera() {
  video = document.createElement("video");
  video.autoplay = true;
  video.playsInline = true;

  stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" }});
  video.srcObject = stream;

  camera.innerHTML = "";
  camera.appendChild(video);

  const crop = document.createElement("div");
  crop.id = "cropBox";
  camera.appendChild(crop);
}

function captureAddress() {
  if (!video.videoWidth) return;

  canvas.width = video.videoWidth;
  canvas.height = video.videoHeight;

  canvas.getContext("2d").drawImage(video, 0, 0);
  processOCR(canvas);
}

/* OCR */
async function processOCR(src) {
  const res = await Tesseract.recognize(src, "eng");
  parseAddress(res.data.text);
}

/* PARSER */
function parseAddress(text) {
  stepAddress.classList.add("hidden");
  stepReview.classList.remove("hidden");

  address.value = text;
  phone.value = (text.match(/[6-9]\d{9}/) || [""])[0];
  pin.value = (text.match(/\b\d{6}\b/) || [""])[0];
}

/* SAVE */
function saveEntry() {
  db.transaction("scans", "readwrite").objectStore("scans").add({
    barcode, name: name.value, phone: phone.value,
    address: address.value, city: city.value, pin: pin.value
  });

  stepReview.classList.add("hidden");
  stepActions.classList.remove("hidden");
}

/* NAV */
function backToBarcode() {
  stream.getTracks().forEach(t => t.stop());
  stepAddress.classList.add("hidden");
  stepBarcode.classList.remove("hidden");
  startBarcodeScanner();
}
function startNew() {
  stream.getTracks().forEach(t => t.stop());
  stepActions.classList.add("hidden");
  stepBarcode.classList.remove("hidden");
  barcodeInput.value = "";
  startBarcodeScanner();
}

/* EXPORT */
function exportAll() {
  const tx = db.transaction("scans", "readonly").objectStore("scans");
  const out = [];
  tx.openCursor().onsuccess = e => {
    const c = e.target.result;
    if (c) { out.push(c.value); c.continue(); }
    else {
      const a = document.createElement("a");
      a.href = URL.createObjectURL(new Blob([JSON.stringify(out, null, 2)]));
      a.download = "courier.json";
      a.click();
    }
  };
}
</script>
</body>
</html>
