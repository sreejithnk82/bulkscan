<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Courier Booking Helper</title>

<script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
<script src="https://unpkg.com/@zxing/library@latest"></script>

<style>
body {
  margin: 0;
  font-family: system-ui, sans-serif;
  background: #0f172a;
  color: #fff;
  overflow-y: auto;
}
.step {
  min-height: 100vh;
  padding: 16px;
  display: none;
}
.step.active { display: block; }

h2 { margin-top: 0; }

.camera-box {
  position: relative;
  width: 100%;
  height: 280px;
  background: black;
  border-radius: 12px;
  overflow: hidden;
}

.crop-guide {
  position: absolute;
  top: 20%;
  left: 10%;
  width: 80%;
  height: 40%;
  border: 2px dashed #38bdf8;
  pointer-events: none;
}

input, textarea, button {
  width: 100%;
  margin-top: 10px;
  padding: 12px;
  border-radius: 10px;
  border: none;
  font-size: 16px;
}
input, textarea {
  background: #020617;
  color: white;
  border: 1px solid #334155;
}
button {
  background: #38bdf8;
  font-weight: bold;
}

.sticky-actions {
  position: sticky;
  bottom: 0;
  background: linear-gradient(to top, #020617, transparent);
  padding: 12px 0;
}

.card {
  background: #020617;
  border-radius: 12px;
  padding: 12px;
  margin-top: 12px;
}
</style>
</head>

<body>

<!-- STEP 1 -->
<div class="step active" id="step1">
<h2>Scan Barcode</h2>

<div class="camera-box" id="barcodeCam"></div>

<input id="barcodeInput" placeholder="Scan or enter barcode manually">

<div class="sticky-actions">
<button onclick="goStep2()">Next</button>
</div>
</div>

<!-- STEP 2 -->
<div class="step" id="step2">
<h2>Scan Address</h2>

<div class="camera-box">
<video id="addressVideo" autoplay playsinline></video>
<div class="crop-guide"></div>
</div>

<div class="sticky-actions">
<button onclick="captureAddress()">Capture Address</button>
<button onclick="goStep1()">Back</button>
</div>
</div>

<!-- STEP 3 -->
<div class="step" id="step3">
<h2>Review Address</h2>

<input id="name" placeholder="Name">
<input id="phone" placeholder="Phone">
<textarea id="address" placeholder="Full address"></textarea>
<input id="city" placeholder="City">
<input id="pin" placeholder="PIN Code">

<div class="sticky-actions">
<button onclick="goStep4()">Confirm</button>
<button onclick="goStep2()">Rescan</button>
</div>
</div>

<!-- STEP 4 -->
<div class="step" id="step4">
<h2>Saved âœ”</h2>
<div class="card" id="summary"></div>

<div class="sticky-actions">
<button onclick="newScan()">Scan New</button>
<button onclick="exportData()">Export All</button>
</div>
</div>

<canvas id="canvas" hidden></canvas>

<script>
let bookings = [];
let current = {};
let barcodeReader;
let barcodeStream;
let addressStream;

/* ---------- BARCODE ---------- */
async function startBarcode() {
  const video = document.createElement("video");
  video.setAttribute("playsinline", true);
  document.getElementById("barcodeCam").innerHTML = "";
  document.getElementById("barcodeCam").appendChild(video);

  barcodeReader = new ZXing.BrowserMultiFormatReader();
  barcodeStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
  video.srcObject = barcodeStream;
  await video.play();

  barcodeReader.decodeFromVideoElement(video, (res) => {
    if (res) {
      barcodeInput.value = res.text;
      stopBarcode();
    }
  });
}

function stopBarcode() {
  barcodeReader?.reset();
  barcodeStream?.getTracks().forEach(t => t.stop());
}

/* ---------- ADDRESS CAMERA ---------- */
async function startAddressCam() {
  addressStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
  addressVideo.srcObject = addressStream;
}

function captureAddress() {
  const v = addressVideo;
  const c = canvas;
  const ctx = c.getContext("2d");

  c.width = v.videoWidth * 0.8;
  c.height = v.videoHeight * 0.4;

  ctx.drawImage(v,
    v.videoWidth * 0.1,
    v.videoHeight * 0.2,
    c.width,
    c.height,
    0, 0, c.width, c.height
  );

  preprocess(ctx, c.width, c.height);

  addressStream.getTracks().forEach(t => t.stop());

  Tesseract.recognize(c, "eng").then(r => {
    parseAddress(r.data.text);
    show("step3");
  });
}

function preprocess(ctx,w,h){
  let img=ctx.getImageData(0,0,w,h),d=img.data;
  for(let i=0;i<d.length;i+=4){
    let v=(d[i]+d[i+1]+d[i+2])/3;
    v=v>140?255:0;
    d[i]=d[i+1]=d[i+2]=v;
  }
  ctx.putImageData(img,0,0);
}

/* ---------- PARSER ---------- */
function parseAddress(text){
  const lines=text.split("\n").map(l=>l.trim()).filter(Boolean);
  phone.value = (text.match(/\b[6-9]\d{9}\b/)||[""])[0];
  pin.value = (text.match(/\b[1-9]\d{5}\b/)||[""])[0];
  name.value = lines.find(l=>!/\d/.test(l))||"";
  address.value = lines.join("\n");
  city.value = "";
}

/* ---------- FLOW ---------- */
function show(id){
  document.querySelectorAll(".step").forEach(s=>s.classList.remove("active"));
  document.getElementById(id).classList.add("active");
}

function goStep1(){ show("step1"); startBarcode(); }
function goStep2(){ current.barcode=barcodeInput.value; show("step2"); startAddressCam(); }
function goStep4(){
  bookings.push({...current,
    name:name.value,
    phone:phone.value,
    address:address.value,
    city:city.value,
    pin:pin.value,
    time:new Date().toISOString()
  });
  summary.innerText = JSON.stringify(bookings.at(-1),null,2);
  show("step4");
}

function newScan(){ show("step1"); startBarcode(); }

/* ---------- EXPORT ---------- */
function exportData(){
  const b=new Blob([JSON.stringify(bookings,null,2)],{type:"application/json"});
  const a=document.createElement("a");
  a.href=URL.createObjectURL(b);
  a.download="courier_data.json";
  a.click();
  if(confirm("Clear data?")) bookings=[];
}

/* INIT */
startBarcode();
</script>
</body>
</html>
