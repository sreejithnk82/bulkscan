<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
<title>Courier Booking Helper</title>

<script src="https://unpkg.com/html5-qrcode"></script>
<script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>

<style>
body {
  margin: 0;
  height: 100vh;
  display: flex;
  flex-direction: column;
  font-family: system-ui, sans-serif;
  overflow: hidden;
}

#camera {
  flex: 1;
  position: relative;
  background: black;
}

#controls {
  background: #fff;
  padding: 12px;
  border-top: 1px solid #ccc;
}

input, textarea, button {
  width: 100%;
  font-size: 16px;
  padding: 10px;
  margin-top: 8px;
}

button {
  background: #007bff;
  color: white;
  border: none;
  border-radius: 4px;
}

.secondary {
  background: #6c757d;
}

.hidden {
  display: none;
}

#cropBox {
  position: absolute;
  border: 2px dashed yellow;
  width: 80%;
  height: 40%;
  top: 30%;
  left: 10%;
  pointer-events: none;
}
</style>
</head>

<body>

<div id="camera">
  <div id="reader"></div>
  <div id="cropBox" class="hidden"></div>
</div>

<div id="controls">

  <!-- BARCODE STEP -->
  <div id="stepBarcode">
    <strong>Scan Barcode</strong>
    <input id="barcodeInput" placeholder="Enter or verify barcode">
    <button onclick="goToAddress()">Next</button>
  </div>

  <!-- ADDRESS CAPTURE -->
  <div id="stepAddress" class="hidden">
    <strong>Capture Address</strong>
    <button onclick="captureAddress()">Capture Address</button>
    <button class="secondary" onclick="rescanBarcode()">Back</button>
  </div>

  <!-- REVIEW -->
  <div id="stepReview" class="hidden">
    <strong>Review Address</strong>

    <input id="name" placeholder="Name">
    <input id="phone" placeholder="Phone">
    <textarea id="address" rows="4" placeholder="Address"></textarea>
    <input id="city" placeholder="City">
    <input id="pin" placeholder="PIN Code">

    <button onclick="saveEntry()">Approve & Save</button>
    <button class="secondary" onclick="rescanAddress()">Rescan Address</button>
  </div>

  <!-- ACTIONS -->
  <div id="stepActions" class="hidden">
    <button onclick="startNew()">Scan New</button>
    <button class="secondary" onclick="exportAll()">Export All</button>
  </div>

</div>

<canvas id="canvas" class="hidden"></canvas>

<script>
let barcode = "";
let videoStream;
let db;

/* ---------- IndexedDB ---------- */
const req = indexedDB.open("courierDB", 1);
req.onupgradeneeded = e => {
  db = e.target.result;
  db.createObjectStore("scans", { autoIncrement: true });
};
req.onsuccess = e => db = e.target.result;

/* ---------- BARCODE ---------- */
const html5QrCode = new Html5Qrcode("reader");

html5QrCode.start(
  { facingMode: "environment" },
  { fps: 10, qrbox: 250 },
  text => {
    barcode = text;
    document.getElementById("barcodeInput").value = text;
  }
);

function goToAddress() {
  barcode = barcodeInput.value.trim();
  if (!barcode) return alert("Barcode required");

  stepBarcode.classList.add("hidden");
  stepAddress.classList.remove("hidden");
  cropBox.classList.remove("hidden");
}

function rescanBarcode() {
  stepAddress.classList.add("hidden");
  stepBarcode.classList.remove("hidden");
}

/* ---------- ADDRESS CAPTURE ---------- */
async function captureAddress() {
  const video = document.querySelector("video");
  const canvas = document.getElementById("canvas");
  const ctx = canvas.getContext("2d");

  const w = video.videoWidth;
  const h = video.videoHeight;

  canvas.width = w;
  canvas.height = h;

  ctx.filter = "grayscale(1) contrast(1.4)";
  ctx.drawImage(video, 0, 0, w, h);

  cropAndOCR(canvas);
}

async function cropAndOCR(canvas) {
  const ctx = canvas.getContext("2d");

  const crop = {
    x: canvas.width * 0.1,
    y: canvas.height * 0.3,
    w: canvas.width * 0.8,
    h: canvas.height * 0.4
  };

  const cropped = document.createElement("canvas");
  cropped.width = crop.w * 1.5;
  cropped.height = crop.h * 1.5;

  cropped.getContext("2d").drawImage(
    canvas,
    crop.x, crop.y, crop.w, crop.h,
    0, 0, cropped.width, cropped.height
  );

  const { data } = await Tesseract.recognize(cropped, "eng", {
    preserve_interword_spaces: 1
  });

  parseAddress(data.text);
}

/* ---------- PARSER ---------- */
function parseAddress(text) {
  stepAddress.classList.add("hidden");
  stepReview.classList.remove("hidden");
  cropBox.classList.add("hidden");

  address.value = text.trim();

  const phoneMatch = text.match(/(?:\+91[-\s]?)?[6-9]\d{9}/);
  phone.value = phoneMatch ? phoneMatch[0] : "";

  const pinMatch = text.match(/\b\d{6}\b/);
  pin.value = pinMatch ? pinMatch[0] : "";

  const lines = text.split("\n").map(l => l.trim()).filter(Boolean);
  name.value = lines.find(l => /^[A-Za-z .]{3,}$/.test(l)) || "";
  city.value = lines[lines.length - 2] || "";
}

/* ---------- SAVE ---------- */
function saveEntry() {
  const tx = db.transaction("scans", "readwrite");
  tx.objectStore("scans").add({
    barcode,
    name: name.value,
    phone: phone.value,
    address: address.value,
    city: city.value,
    pin: pin.value,
    time: Date.now()
  });

  stepReview.classList.add("hidden");
  stepActions.classList.remove("hidden");
}

function rescanAddress() {
  stepReview.classList.add("hidden");
  stepAddress.classList.remove("hidden");
  cropBox.classList.remove("hidden");
}

/* ---------- ACTIONS ---------- */
function startNew() {
  stepActions.classList.add("hidden");
  stepBarcode.classList.remove("hidden");
  barcodeInput.value = "";
}

function exportAll() {
  const tx = db.transaction("scans", "readonly");
  const store = tx.objectStore("scans");
  const data = [];

  store.openCursor().onsuccess = e => {
    const cur = e.target.result;
    if (cur) {
      data.push(cur.value);
      cur.continue();
    } else {
      const blob = new Blob([JSON.stringify(data, null, 2)], { type: "application/json" });
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = "courier_data.json";
      a.click();

      if (confirm("Clear stored data?")) {
        db.transaction("scans", "readwrite").objectStore("scans").clear();
      }
    }
  };
}
</script>

</body>
</html>
