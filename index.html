<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Courier Booking Helper</title>

<script src="https://unpkg.com/html5-qrcode"></script>
<script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>

<style>
body {
  margin: 0;
  font-family: system-ui, sans-serif;
  background: #f5f5f5;
}

.page {
  display: none;
  padding: 10px;
}

.page.active {
  display: block;
}

#camera {
  height: 60vh;
  background: black;
}

.controls {
  padding: 10px;
  background: white;
  position: sticky;
  bottom: 0;
}

button {
  width: 100%;
  padding: 14px;
  margin-top: 8px;
  font-size: 16px;
}

input, textarea {
  width: 100%;
  padding: 10px;
  font-size: 15px;
  margin-top: 8px;
}

pre {
  background: #eee;
  padding: 10px;
  white-space: pre-wrap;
}
</style>
</head>

<body>

<!-- PAGE 1: BARCODE -->
<div id="pageBarcode" class="page active">
  <h3>Scan Barcode</h3>

  <div id="camera"></div>

  <div class="controls">
    <label>Manual Barcode</label>
    <input id="manualBarcode" placeholder="Enter barcode">

    <button onclick="nextFromBarcode()">Next</button>
  </div>
</div>

<!-- PAGE 2: ADDRESS PHOTO -->
<div id="pageAddress" class="page">
  <h3>Capture Address</h3>

  <div id="camera"></div>

  <div class="controls">
    <button onclick="capturePhoto()">ðŸ“¸ Capture Photo</button>
    <button onclick="goBack()">â¬… Back</button>
  </div>
</div>

<!-- PAGE 3: REVIEW -->
<div id="pageReview" class="page">
  <h3>Review & Edit</h3>

  <label>Name</label>
  <input id="name">

  <label>Phone</label>
  <input id="phone">

  <label>Address</label>
  <textarea id="address" rows="4"></textarea>

  <label>City</label>
  <input id="city">

  <label>Pincode</label>
  <input id="pincode">

  <button onclick="saveEntry()">Approve & Save</button>
  <button onclick="rescanAddress()">Rescan Address</button>
</div>

<!-- PAGE 4: EXPORT -->
<div id="pageExport" class="page">
  <h3>Saved Entries</h3>
  <pre id="output"></pre>

  <button onclick="startNew()">Scan New</button>
  <button onclick="exportData()">Export All</button>
</div>

<script>
let scanner;
let currentBarcode = "";
let entries = [];

function showPage(id) {
  document.querySelectorAll(".page").forEach(p => p.classList.remove("active"));
  document.getElementById(id).classList.add("active");
}

function startScanner(mode) {
  if (scanner) scanner.stop();

  scanner = new Html5Qrcode("camera");
  if (mode === "barcode") {
    scanner.start(
      { facingMode: "environment" },
      { fps: 10, qrbox: 250 },
      txt => {
        currentBarcode = txt;
        document.getElementById("manualBarcode").value = txt;
        scanner.stop();
      }
    );
  }
}

startScanner("barcode");

function nextFromBarcode() {
  currentBarcode = document.getElementById("manualBarcode").value.trim();
  if (!currentBarcode) return alert("Barcode required");

  showPage("pageAddress");
}

function capturePhoto() {
  const video = document.querySelector("#camera video");
  const canvas = document.createElement("canvas");
  canvas.width = video.videoWidth;
  canvas.height = video.videoHeight;
  canvas.getContext("2d").drawImage(video, 0, 0);

  runOCR(canvas.toDataURL());
}

async function runOCR(img) {
  alert("Reading address, please wait...");
  const res = await Tesseract.recognize(img, "eng");
  parseAddress(res.data.text);
  showPage("pageReview");
}

function parseAddress(text) {
  document.getElementById("address").value = text.trim();

  const phone = text.match(/\b\d{10}\b/);
  document.getElementById("phone").value = phone ? phone[0] : "";

  const pin = text.match(/\b\d{6}\b/);
  document.getElementById("pincode").value = pin ? pin[0] : "";

  const city = text.match(/(Bangalore|Chennai|Mumbai|Delhi|Kolkata|Hyderabad)/i);
  document.getElementById("city").value = city ? city[0] : "";

  const name = text.split("\n")[0];
  document.getElementById("name").value = name;
}

function saveEntry() {
  entries.push({
    barcode: currentBarcode,
    name: name.value,
    phone: phone.value,
    address: address.value,
    city: city.value,
    pincode: pincode.value
  });

  document.getElementById("output").textContent = JSON.stringify(entries, null, 2);
  showPage("pageExport");
}

function exportData() {
  const blob = new Blob([JSON.stringify(entries)], { type: "application/json" });
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "courier-data.json";
  a.click();

  if (confirm("Clear stored data?")) {
    entries = [];
    startNew();
  }
}

function startNew() {
  showPage("pageBarcode");
  startScanner("barcode");
}

function rescanAddress() {
  showPage("pageAddress");
}

function goBack() {
  showPage("pageBarcode");
  startScanner("barcode");
}
</script>

</body>
</html>
